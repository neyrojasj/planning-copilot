# Code Audit

> Perform a comprehensive code audit based on installed best practices

## Pre-Requisites Check (CRITICAL - DO THIS FIRST!)

```
CHECK if .copilot/standards/ directory exists AND contains at least one .md file

IF no standards found:
  ‚ùå STOP IMMEDIATELY
  
  Display:
  "‚õî **Code Audit Cannot Proceed**
  
  No best practices standards found in `.copilot/standards/`.
  
  **To fix this:**
  1. Run the Smart Agent installer with standards: `./install-with-standards.sh`
  2. Or manually add standard files to `.copilot/standards/`
  
  Available standards:
  - `general.md` - General coding best practices
  - `nodejs.md` - Node.js/TypeScript specific
  - `rust.md` - Rust specific
  
  Cannot audit code without defined standards to audit against."
  
  EXIT - Do not proceed with audit
```

## Audit Process

### Step 1: Load Standards

```
Read ALL .md files from .copilot/standards/
For each standard file:
  - Extract the rules and guidelines
  - Note the category (general, language-specific, framework-specific)
  - Build a checklist of items to verify
```

### Step 2: Load Project Context

```
Read .copilot/docs/index.yaml
From index, determine:
  - Primary language(s)
  - Framework(s) in use
  - Project structure
  - Key modules to audit

Only load standards relevant to the project's tech stack
```

### Step 3: Scan Codebase

```
For each applicable standard category:
  
  1. SECURITY
     - Check for hardcoded secrets/credentials
     - Verify input validation patterns
     - Check authentication/authorization implementations
     - Look for SQL injection vulnerabilities
     - Check for XSS vulnerabilities
     
  2. CODE QUALITY
     - Verify naming conventions
     - Check for code duplication
     - Verify error handling patterns
     - Check function/file length
     - Verify comments and documentation
     
  3. ARCHITECTURE
     - Verify layer separation
     - Check dependency injection patterns
     - Verify single responsibility principle
     - Check for circular dependencies
     
  4. TESTING
     - Check test coverage presence
     - Verify test naming conventions
     - Look for missing edge case tests
     
  5. PERFORMANCE
     - Check for N+1 query patterns
     - Verify async/await usage
     - Look for memory leak patterns
     - Check for unnecessary computations
     
  6. DEPENDENCIES
     - Check for outdated packages
     - Verify no unused dependencies
     - Check for security vulnerabilities
```

### Step 4: Generate Report

Create audit report at `.copilot/tmp/audit-report-[TIMESTAMP].md`:

```markdown
# Code Audit Report

**Project:** [project name]
**Date:** [current date]
**Standards Applied:** [list of standard files used]

## Summary

| Category | Issues Found | Severity |
|----------|--------------|----------|
| Security | X | üî¥ Critical / üü° Warning |
| Code Quality | X | üü° Warning / üü¢ Info |
| Architecture | X | ... |
| Testing | X | ... |
| Performance | X | ... |
| Dependencies | X | ... |

**Total Issues:** X
**Critical:** X | **Warning:** X | **Info:** X

## Critical Issues (Fix Immediately)

### [ISSUE-001] [Title]
- **Category:** Security
- **Severity:** üî¥ Critical
- **Location:** `path/to/file.ts:LINE`
- **Standard Violated:** [Reference to standard]
- **Description:** [What's wrong]
- **Recommendation:** [How to fix]
- **Example Fix:**
  ```typescript
  // Before
  [problematic code]
  
  // After
  [fixed code]
  ```

## Warnings (Fix Soon)

### [ISSUE-XXX] ...

## Informational (Consider Fixing)

### [ISSUE-XXX] ...

## Passed Checks ‚úÖ

- [List of standards that passed]

## Recommendations

### Immediate Actions
1. [ ] Fix critical security issues
2. [ ] ...

### Short-term (This Sprint)
1. [ ] Address warning-level issues
2. [ ] ...

### Long-term (Backlog)
1. [ ] Consider refactoring suggestions
2. [ ] ...

---
*Generated by Smart Agent Code Audit*
*Standards version: [date of standards files]*
```

## Output Format

After audit completes, display:

```
üìä **Code Audit Complete**

**Standards Applied:** [count] files from `.copilot/standards/`

**Results Summary:**
- üî¥ Critical: X issues
- üü° Warning: X issues  
- üü¢ Info: X suggestions

**Full Report:** `.copilot/tmp/audit-report-[TIMESTAMP].md`

**Top Priority Actions:**
1. [Most critical issue]
2. [Second most critical]
3. [Third most critical]

Run `@smart` and ask to "fix audit issue [ISSUE-ID]" to address specific issues.
```

## Notes

- Only audit files matching the project's primary languages
- Skip `node_modules/`, `vendor/`, `dist/`, `build/`, `.git/`
- Skip files in `.copilot/tmp/`
- Focus on patterns, not style (leave style to linters)
- Reference specific line numbers when possible
- Provide actionable, copy-paste-ready fixes
